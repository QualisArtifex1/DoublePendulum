<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Double Pendulum ‚Äî Deterministic (seed=42), 1024√ó1024</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#121822; --ink:#e6edf3; --muted:#9fb0c0;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{display:flex;gap:14px;align-items:flex-start;justify-content:center;padding:16px;}
  canvas{background:#05070a;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.5)}
  .panel{min-width:320px;max-width:420px;background:var(--panel);border:1px solid rgba(255,255,255,.05);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,.5);position:sticky;top:16px}
  .panel h1{font-size:16px;margin:0 0 10px 0}
  .row{display:grid;grid-template-columns:1fr minmax(120px, 1.3fr) auto;gap:8px;align-items:center;margin:8px 0}
  .row label{color:var(--muted)}
  .row input[type=range]{width:100%}
  .buttons{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  button{background:#1c2330;color:var(--ink);border:1px solid rgba(255,255,255,.08);padding:8px 10px;border-radius:10px;cursor:pointer}
  button:active{transform:translateY(1px)}
  .meta{color:var(--muted);font-size:12px;margin-top:10px}
  .hint{color:#89b4ff;font-size:12px;margin-top:8px}
  .small{font-size:12px;color:var(--muted)}
  code{background:#0f1520;padding:2px 6px;border-radius:6px}
</style>
</head>
<body>
  <div class="wrap">
    <canvas id="pendulum" width="1024" height="1024" aria-label="Double pendulum visualization (1024√ó1024)"></canvas>

    <div class="panel" role="group" aria-label="Controls">
      <h1>Double Pendulum ‚Äî <span class="small">deterministic with seed <code>42</code></span></h1>

      <div class="row"><label for="m1">Mass 1</label>
        <input id="m1" type="range" min="0.1" max="10" step="0.1" value="3.0">
        <span id="m1v">3.0</span></div>

      <div class="row"><label for="m2">Mass 2</label>
        <input id="m2" type="range" min="0.1" max="10" step="0.1" value="2.5">
        <span id="m2v">2.5</span></div>

      <div class="row"><label for="l1">Length 1 (px)</label>
        <input id="l1" type="range" min="50" max="480" step="1" value="260">
        <span id="l1v">260</span></div>

      <div class="row"><label for="l2">Length 2 (px)</label>
        <input id="l2" type="range" min="50" max="480" step="1" value="210">
        <span id="l2v">210</span></div>

      <div class="row"><label for="grav">Gravity (px/s¬≤)</label>
        <input id="grav" type="range" min="10" max="2000" step="10" value="980">
        <span id="gravv">980</span></div>

      <div class="row"><label for="damp">Damping (/s)</label>
        <input id="damp" type="range" min="0" max="0.05" step="0.001" value="0.002">
        <span id="dampv">0.0020</span></div>

      <div class="row"><label for="spf">Steps / frame</label>
        <input id="spf" type="range" min="1" max="12" step="1" value="4">
        <span id="spfv">4</span></div>

      <div class="row"><label for="trail">Trail length</label>
        <input id="trail" type="range" min="0" max="5000" step="50" value="2000">
        <span id="trailv">2000</span></div>

      <div class="row"><label for="alpha">Trail fade</label>
        <input id="alpha" type="range" min="0.02" max="0.8" step="0.01" value="0.18">
        <span id="alphav">0.18</span></div>

      <div class="row"><label for="size">Bob size (px)</label>
        <input id="size" type="range" min="4" max="22" step="1" value="10">
        <span id="sizev">10</span></div>

      <div class="buttons">
        <button id="toggle">‚è∏Ô∏è Pause</button>
        <button id="reset">‚ôªÔ∏è Reset (seed 42)</button>
        <button id="clear">üßπ Clear trails</button>
        <button id="snap">üì∏ Snapshot</button>
      </div>

      <div class="hint">Integration uses RK4 with fixed time step (dt = 1/240 s) for deterministic behavior.
        Reset restores seed-based initial angles so runs are reproducible.</div>
      <div class="meta">FPS: <span id="fps">‚Äî</span> ¬∑ Steps simulated: <span id="steps">0</span></div>
    </div>
  </div>

<script>
// ‚Äî‚Äî‚Äî Deterministic PRNG (mulberry32) ‚Äî‚Äî‚Äî
function mulberry32(seed){
  let t = seed >>> 0;
  return function(){
    t += 0x6D2B79F5;
    let r = Math.imul(t ^ (t >>> 15), 1 | t);
    r ^= r + Math.imul(r ^ (r >>> 7), 61 | r);
    return ((r ^ (r >>> 14)) >>> 0) / 4294967296;
  }
}

// Global constants
const SEED = 42;          // fixed seed for reproducibility
const DT = 1/240;         // fixed simulation step (seconds)

// Canvas setup
const canvas = document.getElementById('pendulum');
const ctx = canvas.getContext('2d');
const W = canvas.width, H = canvas.height;
const origin = { x: W/2, y: H/4 }; // anchor point a quarter from top

// UI helpers
function bindRange(id, fmt=(v)=>v){
  const el = document.getElementById(id);
  const out = document.getElementById(id+"v");
  const write = ()=> out.textContent = fmt(Number(el.value));
  el.addEventListener('input', write); write();
  return el;
}

const m1El = bindRange('m1', v=>v.toFixed(1));
const m2El = bindRange('m2', v=>v.toFixed(1));
const l1El = bindRange('l1');
const l2El = bindRange('l2');
const gEl  = bindRange('grav');
const dEl  = bindRange('damp', v=>v.toFixed(4));
const spfEl= bindRange('spf');
const trailEl = bindRange('trail');
const alphaEl = bindRange('alpha', v=>v.toFixed(2));
const sizeEl = bindRange('size');

const fpsEl = document.getElementById('fps');
const stepsEl = document.getElementById('steps');

// Buttons
const toggleBtn = document.getElementById('toggle');
const resetBtn = document.getElementById('reset');
const clearBtn = document.getElementById('clear');
const snapBtn = document.getElementById('snap');

// Simulation state
let a1, a2, w1, w2; // angles and angular velocities
let trail = [];     // trail of bob2 positions
let playing = true;
let stepCount = 0;

function seededInitialState(){
  const rng = mulberry32(SEED);
  // Base angles around 3/4 pi and 1/2 pi, add tiny deterministic jitter
  const base1 = Math.PI * 0.75;
  const base2 = Math.PI * 0.35;
  const jitter = (rng()*2-1) * 0.03; // ¬±0.03 rad
  const jitter2 = (rng()*2-1) * 0.03;
  a1 = base1 + jitter;
  a2 = base2 + jitter2;
  w1 = 0; w2 = 0;
  trail = [];
}

function reset(){
  seededInitialState();
  stepCount = 0;
  clearCanvasHard();
}

function clearCanvasHard(){
  // Hard clear (also clears trails)
  ctx.fillStyle = '#05070a';
  ctx.fillRect(0,0,W,H);
  // Draw anchor crosshair subtly
  ctx.save();
  ctx.globalAlpha = 0.25;
  ctx.strokeStyle = '#0f1724';
  ctx.beginPath();
  ctx.moveTo(origin.x-12, origin.y); ctx.lineTo(origin.x+12, origin.y);
  ctx.moveTo(origin.x, origin.y-12); ctx.lineTo(origin.x, origin.y+12);
  ctx.stroke();
  ctx.restore();
}

function physicsDerivatives(state){
  // state = [a1, a2, w1, w2]
  const [A1, A2, W1, W2] = state;
  const m1 = Number(m1El.value), m2 = Number(m2El.value);
  const L1 = Number(l1El.value), L2 = Number(l2El.value);
  const g  = Number(gEl.value);

  const dA = A1 - A2;
  const sin_dA = Math.sin(dA), cos_dA = Math.cos(dA);
  const denom = 2*m1 + m2 - m2 * Math.cos(2*A1 - 2*A2);

  const a1acc = (
    -g*(2*m1+m2)*Math.sin(A1)
    - m2*g*Math.sin(A1 - 2*A2)
    - 2*sin_dA*m2*(W2*W2*L2 + W1*W1*L1*cos_dA)
  ) / (L1*denom);

  const a2acc = (
    2*sin_dA * (
      W1*W1*L1*(m1+m2) + g*(m1+m2)*Math.cos(A1) + W2*W2*L2*m2*cos_dA
    )
  ) / (L2*denom);

  return [W1, W2, a1acc, a2acc];
}

// RK4 integrator for deterministic, stable stepping
function rk4Step(state, dt){
  const k1 = physicsDerivatives(state);
  const s2 = state.map((v,i)=> v + 0.5*dt*k1[i]);
  const k2 = physicsDerivatives(s2);
  const s3 = state.map((v,i)=> v + 0.5*dt*k2[i]);
  const k3 = physicsDerivatives(s3);
  const s4 = state.map((v,i)=> v + dt*k3[i]);
  const k4 = physicsDerivatives(s4);
  return state.map((v,i)=> v + dt*(k1[i] + 2*k2[i] + 2*k3[i] + k4[i])/6);
}

function stepOnce(){
  const damp = Number(dEl.value); // per-second damping on velocities
  let state = [a1,a2,w1,w2];
  state = rk4Step(state, DT);
  // exponential damping per second
  const factor = Math.max(0, 1 - damp*DT);
  state[2] *= factor; state[3] *= factor;
  [a1,a2,w1,w2] = state;
  stepCount++;
}

function updateTrail(x,y){
  const maxLen = Number(trailEl.value)|0;
  trail.push({x,y});
  if(trail.length>maxLen) trail.shift();
}

function draw(){
  // Faded clear for motion trails
  ctx.fillStyle = `rgba(5,7,10,${Number(alphaEl.value)})`;
  ctx.fillRect(0,0,W,H);

  const L1 = Number(l1El.value), L2 = Number(l2El.value);
  const m1 = Number(m1El.value), m2 = Number(m2El.value);
  const r  = Number(sizeEl.value);

  // Positions
  const x1 = origin.x + L1*Math.sin(a1);
  const y1 = origin.y + L1*Math.cos(a1);
  const x2 = x1 + L2*Math.sin(a2);
  const y2 = y1 + L2*Math.cos(a2);

  updateTrail(x2,y2);

  // Draw trail (bob2)
  if(trail.length>1){
    ctx.beginPath();
    ctx.moveTo(trail[0].x, trail[0].y);
    for(let i=1;i<trail.length;i++) ctx.lineTo(trail[i].x, trail[i].y);
    ctx.strokeStyle = '#4fc3f7';
    ctx.lineWidth = 1.25;
    ctx.globalAlpha = 0.8;
    ctx.stroke();
    ctx.globalAlpha = 1;
  }

  // Rods
  ctx.strokeStyle = '#9fb0c0';
  ctx.lineWidth = 2.0;
  ctx.beginPath();
  ctx.moveTo(origin.x, origin.y);
  ctx.lineTo(x1,y1);
  ctx.lineTo(x2,y2);
  ctx.stroke();

  // Bobs
  ctx.fillStyle = '#e6edf3';
  ctx.beginPath(); ctx.arc(x1,y1, r*Math.cbrt(m1/3), 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(x2,y2, r*Math.cbrt(m2/3), 0, Math.PI*2); ctx.fill();

  // Anchor
  ctx.beginPath(); ctx.arc(origin.x,origin.y, 3, 0, Math.PI*2); ctx.fill();
}

// Animation loop
let lastFpsT=performance.now(), frames=0;
function loop(){
  if(playing){
    const stepsPerFrame = Number(spfEl.value)|0;
    for(let i=0;i<stepsPerFrame;i++) stepOnce();
    draw();
    stepsEl.textContent = stepCount.toString();
  }
  frames++;
  const now = performance.now();
  if(now-lastFpsT>1000){ fpsEl.textContent = frames.toString(); frames=0; lastFpsT=now; }
  requestAnimationFrame(loop);
}

// Button handlers

toggleBtn.addEventListener('click',()=>{
  playing = !playing;
  toggleBtn.textContent = playing ? '‚è∏Ô∏è Pause' : '‚ñ∂Ô∏è Play';
});

resetBtn.addEventListener('click',()=>{ reset(); });
clearBtn.addEventListener('click',()=>{ clearCanvasHard(); trail=[]; });

snapBtn.addEventListener('click',()=>{
  const url = canvas.toDataURL('image/png');
  const a = document.createElement('a');
  a.href = url; a.download = 'double_pendulum_seed42.png'; a.click();
});

// Initialize and start
clearCanvasHard();
reset();
requestAnimationFrame(loop);
</script>
</body>
</html>
